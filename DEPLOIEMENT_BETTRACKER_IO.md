# üöÄ Guide de D√©ploiement - bettracker.io

## üìã Pr√©requis (√† faire avant)

Avant de commencer ce guide, vous devez avoir :
- ‚úÖ Domaine `bettracker.io` ajout√© dans Plesk
- ‚úÖ Sous-domaine `api.bettracker.io` cr√©√© dans Plesk
- ‚úÖ Base de donn√©es PostgreSQL `bettracker_db` cr√©√©e
- ‚úÖ DNS configur√© et propag√©

**Pas encore fait ?** ‚Üí Suivez d'abord **`CONFIGURATION_BETTRACKER_IO.md`**

---

## üåê Architecture de votre application

```
bettracker.io              ‚Üí Frontend Next.js (interface utilisateur)
api.bettracker.io          ‚Üí Backend NestJS (API + base de donn√©es)
```

---

## üìÇ Structure des fichiers sur le serveur

```
/var/www/vhosts/bettracker.io/
‚îÇ
‚îú‚îÄ‚îÄ httpdocs/                          # Frontend
‚îÇ   ‚îú‚îÄ‚îÄ .next/                         # (g√©n√©r√© apr√®s build)
‚îÇ   ‚îú‚îÄ‚îÄ node_modules/                  # (install√© par npm)
‚îÇ   ‚îú‚îÄ‚îÄ .env.local                     # ‚ö†Ô∏è √Ä cr√©er
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ api.bettracker.io/                 # Backend
‚îÇ   ‚îú‚îÄ‚îÄ dist/                          # (g√©n√©r√© apr√®s build)
‚îÇ   ‚îú‚îÄ‚îÄ node_modules/                  # (install√© par npm)
‚îÇ   ‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ .env                           # ‚ö†Ô∏è √Ä cr√©er
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ storage/                           # Fichiers upload√©s
```

---

## üîô PARTIE 1 : D√©ployer le Backend (API)

### √âtape 1.1 : R√©cup√©rer le code via FTP ou SSH

**Option A : Via SSH (recommand√©)**

```bash
# Se connecter en SSH
ssh votre_utilisateur@bettracker.io

# Aller dans le dossier API
cd /var/www/vhosts/bettracker.io/api.bettracker.io

# Cloner le code depuis GitHub
git clone https://github.com/anhost77/netboot.git .

# Aller dans le dossier backend
cd backend
```

**Option B : Via FTP**

1. T√©l√©chargez le projet depuis GitHub en ZIP
2. Extrayez-le sur votre ordinateur
3. Uploadez le contenu du dossier `backend/` vers :
   `/var/www/vhosts/bettracker.io/api.bettracker.io/backend/`

---

### √âtape 1.2 : Cr√©er le fichier de configuration `.env`

**Via SSH :**

```bash
cd /var/www/vhosts/bettracker.io/api.bettracker.io/backend
nano .env
```

**Copiez-collez ce contenu** (remplacez les valeurs entre `[...]`) :

```env
# Application
NODE_ENV=production
PORT=3001
FRONTEND_URL=https://bettracker.io
BACKEND_URL=https://api.bettracker.io

# Database PostgreSQL
DATABASE_URL="postgresql://bettracker_user:[VOTRE_MOT_DE_PASSE_DB]@localhost:5432/bettracker_db"

# JWT - G√©n√©rez des secrets s√©curis√©s !
# Utilisez: node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
JWT_SECRET="[G√âN√âREZ_UN_SECRET_LONG_ET_AL√âATOIRE]"
JWT_REFRESH_SECRET="[G√âN√âREZ_UN_AUTRE_SECRET_LONG_ET_AL√âATOIRE]"
JWT_EXPIRATION="15m"
JWT_REFRESH_EXPIRATION="7d"

# Admin - Credentials pour l'espace admin
ADMIN_EMAIL=admin@bettracker.io
ADMIN_PASSWORD=[CHOISISSEZ_UN_MOT_DE_PASSE_ADMIN_FORT]

# SMTP - Configuration email (optionnel pour commencer)
SMTP_HOST=smtp.votre-hebergeur.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=noreply@bettracker.io
SMTP_PASSWORD=[VOTRE_MOT_DE_PASSE_EMAIL]

# Storage
STORAGE_PATH=/var/www/vhosts/bettracker.io/storage

# Rate Limiting
THROTTLE_TTL=60
THROTTLE_LIMIT=10

# Redis (optionnel - laissez vide pour commencer)
REDIS_HOST=
REDIS_PORT=

# Stripe (optionnel - pour les paiements plus tard)
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
STRIPE_PUBLIC_KEY=
```

**Enregistrer :**
- Nano : `Ctrl+O` puis `Entr√©e`, puis `Ctrl+X`
- Vi : `Esc` puis `:wq`

---

### √âtape 1.3 : G√©n√©rer les secrets JWT

**Via SSH :**

```bash
# G√©n√©rer le JWT_SECRET
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# Copier le r√©sultat et le mettre dans .env √† la ligne JWT_SECRET=

# G√©n√©rer le JWT_REFRESH_SECRET
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# Copier le r√©sultat et le mettre dans .env √† la ligne JWT_REFRESH_SECRET=
```

---

### √âtape 1.4 : Installer les d√©pendances

```bash
cd /var/www/vhosts/bettracker.io/api.bettracker.io/backend

# Installer les d√©pendances Node.js
npm install

# Si vous avez des erreurs, essayez :
npm install --legacy-peer-deps
```

‚è±Ô∏è **Temps estim√© :** 5-10 minutes

---

### √âtape 1.5 : Initialiser la base de donn√©es

```bash
# G√©n√©rer le client Prisma
npx prisma generate

# Lancer les migrations (cr√©er les tables)
npx prisma migrate deploy

# Cr√©er l'utilisateur admin
npm run create-admin
```

**R√©sultat attendu :**
```
‚úÖ Admin user created successfully!
üìß Email: admin@bettracker.io
```

---

### √âtape 1.6 : Builder le backend

```bash
npm run build
```

‚è±Ô∏è **Temps estim√© :** 2-3 minutes

**V√©rifiez que le dossier `dist/` a √©t√© cr√©√© :**
```bash
ls -la dist/
```

---

### √âtape 1.7 : Configurer Node.js dans Plesk

**Via l'interface Plesk :**

1. **Allez dans "Domaines"** ‚Üí S√©lectionnez **`api.bettracker.io`**
2. Cliquez sur **"Node.js"**
3. Configuration :

   ```
   ‚òë Activer Node.js

   Version Node.js : 18.x ou 20.x (LTS)
   Mode : Production
   Document root : /var/www/vhosts/bettracker.io/api.bettracker.io/backend
   Application startup file : dist/main.js

   Variables d'environnement :
   (Copiez-collez le contenu de votre fichier .env)
   ```

4. Cliquez sur **"Activer Node.js"**
5. Cliquez sur **"Red√©marrer l'application"**

---

### √âtape 1.8 : OU D√©marrer avec PM2 (recommand√©)

**Via SSH :**

```bash
# Installer PM2 globalement
npm install -g pm2

# D√©marrer le backend
cd /var/www/vhosts/bettracker.io/api.bettracker.io/backend
pm2 start dist/main.js --name bettracker-backend

# Sauvegarder la configuration
pm2 save

# Auto-d√©marrage au reboot
pm2 startup
# Suivez les instructions affich√©es
```

---

### ‚úÖ √âtape 1.9 : Tester le backend

**Via navigateur :**
Ouvrez : `https://api.bettracker.io/health`

**R√©sultat attendu :**
```json
{"status":"ok"}
```

**Via SSH :**
```bash
curl https://api.bettracker.io/health
```

**Si √ßa ne fonctionne pas :**
- V√©rifiez les logs : `pm2 logs bettracker-backend`
- V√©rifiez que le port 3001 est ouvert
- V√©rifiez le fichier `.env`

---

## üé® PARTIE 2 : D√©ployer le Frontend

### √âtape 2.1 : R√©cup√©rer le code frontend

**Via SSH :**

```bash
# Aller dans le dossier frontend
cd /var/www/vhosts/bettracker.io/httpdocs

# Copier le code frontend depuis le d√©p√¥t
git clone https://github.com/anhost77/netboot.git temp
mv temp/frontend/* .
mv temp/frontend/.* . 2>/dev/null || true
rm -rf temp
```

**Via FTP :**
Uploadez le contenu du dossier `frontend/` vers :
`/var/www/vhosts/bettracker.io/httpdocs/`

---

### √âtape 2.2 : Cr√©er le fichier de configuration `.env.local`

**Via SSH :**

```bash
cd /var/www/vhosts/bettracker.io/httpdocs
nano .env.local
```

**Contenu :**

```env
# API Backend URL
NEXT_PUBLIC_API_URL=https://api.bettracker.io

# Site URL
NEXT_PUBLIC_SITE_URL=https://bettracker.io

# Stripe (optionnel - pour plus tard)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
```

**Enregistrer et quitter**

---

### √âtape 2.3 : Installer les d√©pendances

```bash
cd /var/www/vhosts/bettracker.io/httpdocs
npm install
```

‚è±Ô∏è **Temps estim√© :** 3-5 minutes

---

### √âtape 2.4 : Builder le frontend

```bash
npm run build
```

‚è±Ô∏è **Temps estim√© :** 2-3 minutes

**V√©rifiez que le dossier `.next/` a √©t√© cr√©√© :**
```bash
ls -la .next/
```

---

### √âtape 2.5 : D√©marrer le frontend avec PM2

```bash
cd /var/www/vhosts/bettracker.io/httpdocs

# D√©marrer avec PM2
pm2 start npm --name bettracker-frontend -- start

# Sauvegarder
pm2 save
```

---

### ‚úÖ √âtape 2.6 : Tester le frontend

**Via navigateur :**
Ouvrez : `https://bettracker.io`

**R√©sultat attendu :**
- Page d'accueil de BetTracker
- Ou page de connexion

**Si √ßa ne fonctionne pas :**
- V√©rifiez les logs : `pm2 logs bettracker-frontend`
- V√©rifiez le fichier `.env.local`
- V√©rifiez que l'API fonctionne

---

## üîí PARTIE 3 : Configurer SSL/HTTPS

### √âtape 3.1 : Activer Let's Encrypt

**Pour le domaine principal :**

1. Dans Plesk, allez dans **"Domaines"** ‚Üí **`bettracker.io`**
2. Cliquez sur **"SSL/TLS Certificates"**
3. Cliquez sur **"Install a free basic certificate provided by Let's Encrypt"**
4. Cochez :
   - ‚òë Secure the domain
   - ‚òë Secure www.bettracker.io
5. Cliquez sur **"Get it free"**

**Pour le sous-domaine API :**

1. Dans Plesk, allez dans **"Domaines"** ‚Üí **`api.bettracker.io`**
2. R√©p√©tez les m√™mes √©tapes

---

### √âtape 3.2 : Forcer HTTPS (redirection)

**Dans Plesk :**

1. Allez dans **"Domaines"** ‚Üí **`bettracker.io`**
2. Cliquez sur **"H√©bergement & DNS"** ‚Üí **"Param√®tres Apache & nginx"**
3. Cochez : **‚òë Rediriger HTTP vers HTTPS de mani√®re permanente**
4. Cliquez sur **"OK"**

R√©p√©tez pour `api.bettracker.io`

---

## üîß PARTIE 4 : Configuration Nginx (Proxy)

### √âtape 4.1 : Configurer le proxy pour l'API

**Dans Plesk :**

1. Allez dans **"Domaines"** ‚Üí **`api.bettracker.io`**
2. Cliquez sur **"Apache & nginx Settings"**
3. Dans **"Additional nginx directives"**, ajoutez :

```nginx
location / {
    proxy_pass http://localhost:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
}
```

4. Cliquez sur **"OK"**
5. Cliquez sur **"Appliquer"**

---

## ‚úÖ PARTIE 5 : Tests finaux

### Test 1 : API Backend

```bash
curl https://api.bettracker.io/health
```

**R√©sultat attendu :** `{"status":"ok"}`

---

### Test 2 : Frontend

Ouvrez dans un navigateur : `https://bettracker.io`

**R√©sultat attendu :**
- Page de connexion ou d'accueil
- Pas d'erreur console

---

### Test 3 : Admin

Ouvrez : `https://bettracker.io/admin/login`

Connectez-vous avec :
- **Email** : `admin@bettracker.io`
- **Mot de passe** : (celui du `.env`)

---

### Test 4 : Inscription utilisateur

1. Allez sur : `https://bettracker.io/register`
2. Cr√©ez un compte de test
3. V√©rifiez que √ßa fonctionne

---

## üìä V√©rification compl√®te

### Checklist finale :

- [ ] Backend accessible : `https://api.bettracker.io/health`
- [ ] Frontend accessible : `https://bettracker.io`
- [ ] SSL/HTTPS activ√© (cadenas vert)
- [ ] Admin peut se connecter
- [ ] Inscription fonctionne
- [ ] PM2 actif : `pm2 list`
- [ ] Base de donn√©es connect√©e
- [ ] Logs sans erreurs : `pm2 logs`

---

## üéâ F√©licitations !

Votre application **BetTracker Pro** est maintenant d√©ploy√©e sur **bettracker.io** ! üöÄ

### URLs importantes :

- üåê **Application** : https://bettracker.io
- üîß **API** : https://api.bettracker.io
- üîê **Admin** : https://bettracker.io/admin
- üìö **API Docs** : https://api.bettracker.io/api

---

## üîÑ Pour mettre √† jour plus tard :

```bash
# Se connecter en SSH
ssh votre_utilisateur@bettracker.io

# Backend
cd /var/www/vhosts/bettracker.io/api.bettracker.io/backend
git pull
npm install
npm run build
pm2 restart bettracker-backend

# Frontend
cd /var/www/vhosts/bettracker.io/httpdocs
git pull
npm install
npm run build
pm2 restart bettracker-frontend
```

---

## üìû Besoin d'aide ?

**Commandes utiles :**

```bash
# Voir les logs
pm2 logs

# Statut des services
pm2 status

# Red√©marrer tout
pm2 restart all

# V√©rifier la base de donn√©es
psql -U bettracker_user -d bettracker_db
```

**Fichiers importants :**
- Backend : `/var/www/vhosts/bettracker.io/api.bettracker.io/backend/.env`
- Frontend : `/var/www/vhosts/bettracker.io/httpdocs/.env.local`

---

**Temps total de d√©ploiement :** ~2 heures

Bon lancement ! üéâ
